from fastapi import FastAPI, Query, HTTPException
from pydantic import BaseModel
from app.embed_index import load_index, build_index, embedder
import numpy as np
from app.model_utils import build_prompt, call_openai
from app.config import TOP_K, USE_OPENAI
import faiss
import json

app = FastAPI(title="Aurora Member QnA")

index, docs = load_index()

class AnswerResponse(BaseModel):
    answer: str

def semantic_search(question: str, k=TOP_K):
    q_emb = embedder.encode([question], convert_to_numpy=True).astype("float32")
    D, I = index.search(q_emb, k)
    results = []
    for idx in I[0]:
        if idx < 0 or idx >= len(docs): continue
        results.append(docs[idx])
    return results

@app.get("/ask", response_model=AnswerResponse)
def ask(q: str = Query(..., description="Natural language question about member data")):
    try:
        top_docs = semantic_search(q)
        prompt = build_prompt(q, top_docs)
        if USE_OPENAI:
            answer = call_openai(prompt)
        else:
            joined = "\n\n".join([d['text'] for d in top_docs])
            answer = f"Top matching messages:\n{joined}\n\n(Enable OPENAI_API_KEY to get a concise generated answer.)"
        return {"answer": answer}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/reindex")
def reindex():
    global index, docs
    index, docs = build_index(save=True)
    return {"status": "ok", "total_docs": len(docs)}
